name: C/C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install OpenSSL
      run: sudo apt-get update && sudo apt-get install -y libssl-dev

    - name: Build server and client
      run: make all

    - name: Generate self-signed certificate
      run: |
        openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem \
          -sha256 -days 365 -nodes \
          -subj "/C=JP/ST=Tokyo/L=Tokyo/O=TestOrg/OU=TestOU/CN=localhost"

    - name: Start server in background
      run: |
        ./secure_server &
        echo $! > server.pid
        sleep 3

    - name: Check server is running
      run: |
        SERVER_PID=$(cat server.pid)
        if ! ps -p $SERVER_PID > /dev/null; then
          echo "Server failed to start!"
          exit 1
        fi
        echo "Server is running with PID: $SERVER_PID"

    - name: Test IPv4 normal query
      run: |
        response=$(curl -k -s "https://127.0.0.1:8080/calc?query=1+2+3")
        echo "IPv4 test result: $response"
        if [[ "$response" != "6" ]]; then
          echo "IPv4 test failed! Expected 6, got: $response"
          exit 1
        fi

    - name: Test IPv6 normal query
      run: |
        response=$(curl -k -s "https://[::1]:8080/calc?query=1+2+3")
        echo "IPv6 test result: $response"
        if [[ "$response" != "6" ]]; then
          echo "IPv6 test failed! Expected 6, got: $response"
          exit 1
        fi

    - name: Test multiple numbers
      run: |
        response=$(curl -k -s "https://localhost:8080/calc?query=10+20+30+40")
        echo "Multiple numbers test result: $response"
        if [[ "$response" != "100" ]]; then
          echo "Multiple numbers test failed! Expected 100, got: $response"
          exit 1
        fi

    - name: Test negative numbers
      run: |
        response=$(curl -k -s "https://localhost:8080/calc?query=100+-50")
        echo "Negative numbers test result: $response"
        if [[ "$response" != "50" ]]; then
          echo "Negative numbers test failed! Expected 50, got: $response"
          exit 1
        fi

    - name: Test client connectivity
      run: |
        echo -e "10+20\nexit" | timeout 5 ./secure_client 127.0.0.1 8080 > client_output.txt 2>&1
        if ! grep -q "Result: 30" client_output.txt; then
          echo "Client test failed!"
          cat client_output.txt
          exit 1
        fi
        echo "Client test passed"

    - name: Test graceful shutdown
      run: |
        SERVER_PID=$(cat server.pid)
        kill -SIGTERM $SERVER_PID
        sleep 3
        if ps -p $SERVER_PID > /dev/null; then
          echo "Server did not shutdown gracefully!"
          kill -9 $SERVER_PID
          exit 1
        fi
        echo "Server shut down gracefully"

    - name: Clean up
      if: always()
      run: |
        if [ -f server.pid ]; then
          SERVER_PID=$(cat server.pid)
          kill -9 $SERVER_PID 2>/dev/null || true
        fi
        rm -f server.pid client_output.txt cert.pem key.pem